<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Crypter</title>
    <link rel="stylesheet" href="styles/crypter.css" charset="utf-8">
    <script src="js/common.js" charset="utf-8"></script>
  </head>

  <body>
    <section id="crypt">
      <div class="panel-container">
        <div id="panel-crypt" class="current">
          <a class="navigationLink" data-action="app:open-settings">
            <img class="info" src="images/icons/settings.svg" alt="Settings">
          </a>
          <header>
            <img src="images/icons/Crypter.svg" alt="Crypter" class="header"/>
            <h1 class="title">Crypter</h1>
            <p class="subtitle">Encrypt &amp; decrypt any file.</p>
            <p class="leadinfo">Encrypt unlimited bits. Remember only a bit.<br/>
              All you need is your MasterPass and a CRYTPO file.</p>
            <p id="errLabel" style="display: none"></p>
          </header>
          <!-- TODO: Consider using <input class="fancy" type="file" name="name" value="selectfile"> -->
          <div id="fileInput" class="fancy">
            <p id="fileInputText">
              Select or drop file
            </p>
          </div>
        </div>
        <div id="panel-crypted">
          <div id="crypted-container">
            <!-- Dynamically load file info here -->
          </div>
          <p class="intrfo">
            Note these details down! They may be erased when you navigate back
          </p>
          <footer>
            <a class="back navigationLink" data-panel="crypt">
              <img src="images/icons/back.svg" alt="back"/>
            </a>
          </footer>
        </div>
      </div>
    </section>

    <script id="crypted-template" type="text/x-handlebars-template">
      <header>
        <img src="images/icons/{{op}}.svg" class="header"/>
      </header>
      <div id="finfo">
        <h3>{{op}}
          {{name}}</h3>
        <table>
          <tr>
            <td>Path</td>
            <td>{{path}}</td>
          </tr>
          <tr>
            <td>Crypted to</td>
            <td>{{cryptPath}}</td>
          </tr>
          <tr>
            <td>Initialisation Vector</td>
            <td>
              <input type="text" value="{{iv}}"/>
            </td>
          </tr>
          <tr>
            <td>Authentication Tag</td>
            <td>
              <input type="text" value="{{authTag}}"/>
            </td>
          </tr>
          <tr>
            <td>Salt (for key derivation)</td>
            <td>
              <input type="text" value="{{salt}}"/>
            </td>
          </tr>
          <tr>
            <td>Encryption Key</td>
            <td>
              <input type="text" value="{{key}}"/>
            </td>
          </tr>
        </table>
      </div>
    </script>

    <script type="text/javascript">
      'use strict'
      const dialog = remote.dialog
      const paths = remote.getGlobal('paths')
      const path = require('path')
      // Get DOM elements
      let errLabel = $('#errLabel')
      let fileInput = $('#fileInput')
      let fileInputD = document.getElementById('fileInput')
      let cryptedContainer = $('#crypted-container')
      let fileInputText = fileInput.find('#fileInputText')
      let ifileInputText = fileInputText.text()
      // compile the crypted template
      let crypted_template = Handlebars.compile($('#crypted-template').html())

      $(window).on('load', function() {
        // attach  event
        fileInputD.ondragover = function() {
          return false
        }
        fileInputD.ondragleave = fileInputD.ondragend = function() {
          return false
        }

        turnFileInputOn()
      })

      /* Event listeners */
      ipcRenderer.on('cryptedFile', function(event, file) {
        logger.verbose(`IPCRENDER cryptedFile emitted`)
        var fileHTML = crypted_template(file)
        cryptedContainer.html(fileHTML)
        fileInputText.text(ifileInputText)
        navigate('crypted')
        turnFileInputOn()
      })
      ipcRenderer.on('decryptedFile', function(event, file) {
        logger.verbose(`IPCRENDER decryptedFile emitted`)
        var fileHTML = crypted_template(file)
        cryptedContainer.html(fileHTML)
        fileInputText.text(ifileInputText)
        navigate('crypted')
        turnFileInputOn()
      })
      ipcRenderer.on('cryptErr', function(event, err) {
        logger.verbose(`IPCRENDER cryptErr emitted`)
        errLabel.text(`ERROR: ${err}`).show()
        fileInputText.text(ifileInputText)
        turnFileInputOn()
      })

      /* Helper functions */
      function turnFileInputOff() {
        fileInput.off('click', handler)
        fileInput.ondrop = function() {
          return false
        }
      }
      function turnFileInputOn() {
        fileInput.on('click', handler)
        fileInputD.ondrop = function(e) {
          e.preventDefault()
          logger.info(`ONDROP fired!`)
          if (e.dataTransfer.files[0].path) {
            logger.info(`Got file: ${e.dataTransfer.files[0].path}`)
            handleFile(e.dataTransfer.files[0].path)
          }
          return false
        }
      }
      function handleFile(file) {
        let fileExt = path.extname(file)
        turnFileInputOff()
        errLabel.hide()

        if (fileExt.toLowerCase() === CRYPTO.EXT) {
          // Decrypt file
          fileInputText.text(`Decrypting ${path.basename(file)}...`)
          // send file to decryptFile controller function
          ipcRenderer.send('decryptFile', file)
        } else {
          // Encrypt file
          fileInputText.text(`Encrypting ${path.basename(file)}...`)
          // send file to crypter controller function
          ipcRenderer.send('cryptFile', file)
        }
      }

      function handler() {
        // Prevent multiple input dialog
        fileInput.off('click', handler)
        // Create file input dialog
        dialog.showOpenDialog({
          title: 'Choose a file to Encrypt',
          defaultPath: paths.documents, // open dialog at home directory
          properties: ['openFile']
        }, function(filePath) {
          // callback for selected file returns undefined if file not selected by user
          if (filePath && filePath.length === 1) {
            handleFile(filePath[0])
          } else {
            fileInput.on('click', handler)
          }
        })
        return false
      }
    </script>
  </body>

</html>