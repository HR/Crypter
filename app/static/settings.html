<!doctype html>
<html>

  <head>
    <meta charset="utf-8">
    <title>Settings</title>
    <link rel="stylesheet" href="styles/settings.css">
    <script src="js/common.js" charset="utf-8"></script>
  </head>

  <body>
    <section id="settings">
      <div class="panel-container">
        <div class="menu">
          <a class="item right navigationLink active" data-tab="general">General</a>
          <a class="item  navigationLink" data-tab="contribute">
            <img class="icon" src="images/icons/mark-github.svg" alt="" />
          </a>
        </div>
        <div id="panel-general" class="current">
          <section class="general">
            <header>
              <img class="header" src="images/icons/crypt.svg" alt=""/>
              <h3>General</h3>
            </header>
            <section class="category">
              <h4>Credentials</h4>
              <div class="options" id="creds">
                <div class="option">
                  <button class="navigationLink" data-action="export">Export</button>
                  <button class="navigationLink" data-action="import">Import</button>
                </div>
              </div>
              <p id="errLabel" class="info"></p>
            </section>
          </section>
        </div>
        <div id="panel-contribute">
          <section class="contribute">
            <header>
              <img class="header" src="images/icons/mark-github.svg" alt=""/>
              <h3>Contribute</h3>
            </header>
            <div class="list">
              <div class="item">
                <a class="navigationLink" data-target="https://github.com/HR/Crypter/issues/new">
                  <img src="images/icons/issue-opened.svg" class="icon" alt=""/>
                  <div class="name">
                    Report an issue / Suggest improvements
                  </div>
                </a>
              </div>
              <div class="item">
                <a class="navigationLink" data-target="https://github.com/HR/Crypter">
                  <img src="images/icons/star.svg" alt="" class="icon"/>
                  <div class="name">
                    Star the repo
                  </div>
                </a>
              </div>
              <div class="item">
                <a class="navigationLink" data-target="https://github.com/HR/Crypter/fork">
                  <img src="images/icons/repo-forked.svg" alt="" class="icon"/>
                  <div class="name">
                    Fork the repo
                  </div>
                </a>
              </div>
              <!-- <div class="item">
                <a class="navigationLink" data-action="check-updates">
                  <img src="images/icons/package.svg" alt="" class="icon"/>
                  <div class="name">
                    Check for Updates
                  </div>
                </a>
              </div> -->
            </div>
          </section>
        </div>
        <footer>
          <img src="images/icons/code.svg" alt="" class="icon"/>
          with
          <img src="images/icons/heart.svg" alt="" class="icon"/>
          by
          <br>
          <a class="navigationLink" data-target="https://github.com/HR">Habib Rehman</a>
        </footer>
      </div>
    </section>
    <script id="creds-template" type="text/x-handlebars-template">
      <div class="option">
        <span>MasterPass salt</span>
        <input class="right" type="text" value="{{mpsalt}}" />
      </div>
      <div class="option">
        <span>MasterPassKey hash</span>
        <input class="right" type="text" value="{{mpkhash}}" />
      </div>
      <div class="option">
        <span>MasterPassKey salt</span>
        <input class="right" type="text" value="{{mpksalt}}" />
      </div>
    </script>
    <script type="text/javascript">
      'use strict'
      // load core modules first
      const dialog = remote.dialog
      const creds = remote.getGlobal('creds')
      const paths = remote.getGlobal('paths')
      const buf2hex = require('../core/crypto').buf2hex
      const errLabel = $('#errLabel')
      // var settings = remote.getGlobal("settings")

      $(window).on('load', function() {
        // Render the credentials
        var creds_temp = Handlebars.compile($("#creds-template").html())
        $('#creds').prepend(creds_temp({
          mpsalt: buf2hex(creds.mpsalt),
          mpkhash: creds.mpkhash,
          mpksalt: creds.mpksalt
        }))
      })

      ipcRenderer.on('export', function () {
        dialog.showOpenDialog({
          title: 'Choose a dir to export to',
          defaultPath: paths.documents,
          properties: ['openDirectory']
        }, function(dirPath) {
          // callback for selected file
          // returns undefined if file not selected by user
          if (dirPath && dirPath.length === 1) {
            errLabel.hide()
            console.log(`Got dirpath ${dirPath[0]}`);
            ipcRenderer.send('export', dirPath[0])
          }
        })
      })

      ipcRenderer.on('exportResult', function (event, err) {
        if (err) {
          errLabel.text(`ERROR: ${err.message}`.toUpperCase()).css('color', COLORS.bad).show()
        } else {
          errLabel.text(RESPONSES.exportSuccess).css('color', COLORS.good).show()
        }
      })

      ipcRenderer.on('import', function () {
        dialog.showOpenDialog({
          title: 'Choose the crypter credentials file',
          defaultPath: paths.documents,
          properties: ['openFile']
        }, function(filePath) {
          // callback for selected file
          // returns undefined if file not selected by user
          if (filePath && filePath.length === 1) {
            errLabel.hide()
            console.log(`Got filePath ${filePath[0]}`);
            ipcRenderer.send('import', filePath[0])
          }
        })
      })

      ipcRenderer.on('importResult', function (event, err) {
        window.erro = err
        if (err) {
          console.log(JSON.stringify(err))
          errLabel.text(`ERROR: ${err}`.toUpperCase()).css('color', COLORS.bad).show()
        } else {
          errLabel.text(RESPONSES.importSuccess).css('color', COLORS.good).show()
        }
      })
    </script>
  </body>

</html>
